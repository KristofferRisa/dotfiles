#!/usr/bin/env bash
# yt-extract - Extract knowledge from YouTube videos using Claude Code
# Usage: yt-extract <youtube-url> [output-name]

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

WORKSPACE_DIR="${CLAUDE_WORKSPACE:-$HOME/claude-workspace}"
PROMPT_FILE="$WORKSPACE_DIR/prompts/extract-youtube-knowledge.md"
OUTPUT_DIR="${OBSIDIAN_VAULT:-$WORKSPACE_DIR/output}"

# Check dependencies
check_deps() {
    local deps=("yt-dlp" "jq")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            echo -e "${RED}Error: $dep is not installed${NC}"
            echo "Install with: brew install $dep (macOS) or apt install $dep (Linux)"
            exit 1
        fi
    done
}

# Get video info and transcript
get_transcript() {
    local url="$1"
    local video_id=$(echo "$url" | grep -oP '(?<=v=)[^&]+' || echo "$url" | grep -oP '(?<=youtu.be/)[^?]+')
    
    echo -e "${YELLOW}Fetching video information...${NC}"
    
    # Get video metadata
    local metadata=$(yt-dlp --skip-download --print-json "$url" 2>/dev/null)
    local title=$(echo "$metadata" | jq -r '.title')
    local channel=$(echo "$metadata" | jq -r '.channel')
    local upload_date=$(echo "$metadata" | jq -r '.upload_date')
    
    echo -e "${GREEN}Title: $title${NC}"
    echo -e "${GREEN}Channel: $channel${NC}"
    
    # Download transcript
    echo -e "${YELLOW}Downloading transcript...${NC}"
    local transcript=$(yt-dlp --skip-download --write-auto-sub --sub-lang en --sub-format vtt --print after_move:filepath "$url" 2>&1 | grep -v "WARNING")
    
    # Try manual subtitles if auto-generated aren't available
    if [ $? -ne 0 ]; then
        echo -e "${YELLOW}Auto-generated subtitles not found, trying manual subtitles...${NC}"
        transcript=$(yt-dlp --skip-download --write-sub --sub-lang en --sub-format vtt --convert-subs srt "$url" 2>/dev/null)
    fi
    
    # Format output
    echo "---"
    echo "VIDEO METADATA:"
    echo "Title: $title"
    echo "Channel: $channel"
    echo "Date: $upload_date"
    echo "URL: $url"
    echo "---"
    echo ""
    echo "TRANSCRIPT:"
    
    # Get the subtitle file and clean it
    local subtitle_file=$(ls *.en.vtt 2>/dev/null | head -n 1)
    if [ -z "$subtitle_file" ]; then
        subtitle_file=$(ls *.en.srt 2>/dev/null | head -n 1)
    fi
    
    if [ -n "$subtitle_file" ]; then
        # Clean VTT/SRT format (remove timestamps and formatting)
        sed -e '/^[0-9]/d' -e '/-->/d' -e '/^$/d' -e 's/<[^>]*>//g' "$subtitle_file" | \
            tr '\n' ' ' | sed 's/  */ /g'
        rm "$subtitle_file"
    else
        echo -e "${RED}Could not find transcript file${NC}"
        exit 1
    fi
}

# Main function
main() {
    if [ $# -lt 1 ]; then
        echo "Usage: yt-extract <youtube-url> [output-name]"
        echo "Example: yt-extract 'https://www.youtube.com/watch?v=dQw4w9WgXcQ' 'my-notes'"
        exit 1
    fi
    
    local url="$1"
    local output_name="${2:-youtube-extract-$(date +%Y%m%d-%H%M%S)}"
    
    check_deps
    
    # Create temp file with transcript
    local temp_file=$(mktemp)
    get_transcript "$url" > "$temp_file"
    
    echo -e "\n${YELLOW}Processing with Claude Code...${NC}"
    
    # Create the output file path
    local output_file="$OUTPUT_DIR/${output_name}.md"
    
    # Call Claude Code with the prompt and transcript
    if [ -f "$PROMPT_FILE" ]; then
        echo -e "${GREEN}Using prompt: $PROMPT_FILE${NC}"
        # This is where you'd integrate with Claude Code
        # For now, showing the command structure
        echo -e "${YELLOW}Run this command:${NC}"
        echo "claude-code \"Apply the instructions in $PROMPT_FILE to this transcript: $(cat $temp_file)\" > \"$output_file\""
    else
        echo -e "${RED}Prompt file not found: $PROMPT_FILE${NC}"
        echo "Creating basic extraction..."
        echo "Please process the transcript in: $temp_file"
    fi
    
    # Cleanup
    rm "$temp_file"
    
    echo -e "${GREEN}âœ“ Complete! Output saved to: $output_file${NC}"
}

main "$@"
